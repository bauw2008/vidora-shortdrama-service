name: 清理工作流运行记录

on:
  schedule:
    - cron: '0 11 */5 * *'
  workflow_dispatch:

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  cleanup-workflows:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # --- 关键修复：必须添加以下权限配置 ---
    permissions:
      actions: write
      contents: read
    # ------------------------------------

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 获取工作流运行记录
        id: list-runs
        run: |
          echo "========================================"
          CUTOFF_DATETIME=$(date -d '2 days ago' -u +%Y-%m-%dT%H:%M:%SZ)
          echo "清理 $CUTOFF_DATETIME 之前的记录"

          # 获取2天前的所有运行记录 ID（不限状态）
          OLD_RUNS=$(gh run list --limit 200 --json databaseId,startedAt \
            | jq -r '.[] | select(.startedAt < "'$CUTOFF_DATETIME'") | .databaseId')

          # 统计行数，处理空结果
          if [ -z "$OLD_RUNS" ]; then
            COUNT=0
          else
            COUNT=$(echo "$OLD_RUNS" | wc -l)
          fi

          echo "$OLD_RUNS" > /tmp/old_runs.txt
          echo "old_runs_count=$COUNT" >> $GITHUB_OUTPUT
          echo "找到记录数量: $COUNT"
          echo "========================================"

      - name: 清理旧的工作流运行记录
        if: steps.list-runs.outputs.old_runs_count != '0'
        run: |
          echo "开始清理..."
          OLD_RUNS=$(cat /tmp/old_runs.txt)
          COUNT=0
          
          for RUN_ID in $OLD_RUNS; do
            if [ -n "$RUN_ID" ]; then
              echo "正在删除: $RUN_ID"
              # --- 优化：添加 || true 避免单个失败导致整个 Job 挂掉 ---
              gh run delete "$RUN_ID" || echo "删除 $RUN_ID 失败，可能已被手动清理"
              COUNT=$((COUNT + 1))
            fi
          done
          echo "✅ 已完成 $COUNT 个记录的处理"

      - name: 无需清理
        if: steps.list-runs.outputs.old_runs_count == '0'
        run: echo "✅ 没有需要清理的记录"
