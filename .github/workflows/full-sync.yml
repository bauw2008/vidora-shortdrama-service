name: 完整同步

on:
  # 手动触发
  workflow_dispatch:

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  full-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6小时超时

    steps:
      - name: 设置时区
        run: sudo timedatectl set-timezone Asia/Shanghai

      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 安装依赖
        run: |
          pnpm install --no-frozen-lockfile

      - name: 执行完整同步
        id: sync
        run: |
          echo "========================================"
          echo "开始完整数据同步"
          echo "========================================"
          echo "开始时间: $(date)"
          echo "========================================"

          # 执行完整同步脚本
          node -e "
          const { execSync } = require('child_process');
          try {
            execSync('npx tsx lib/sync.ts full', { stdio: 'inherit' });
          } catch (error) {
            console.error('同步失败:', error);
            process.exit(1);
          }
          "

          echo "========================================"
          echo "✅ 完整同步完成"
          echo "完成时间: $(date)"
          echo "========================================"

      - name: 同步失败处理
        if: failure()
        run: |
          echo "========================================"
          echo "❌ 完整同步失败"
          echo "========================================"
          echo "请检查："
          echo "1. 数据源 API 是否可访问"
          echo "2. Supabase 配置是否正确"
          echo "3. 网络连接是否正常"
          echo "========================================"
          exit 1