name: 测试增量同步

on:
  # 手动触发（仅用于测试）
  workflow_dispatch:

env:
  API_URL: ${{ secrets.API_URL }}
  ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}

jobs:
  test-incremental-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 30分钟超时

    steps:
      - name: 执行增量同步测试
        id: sync
        run: |
          echo "开始测试增量同步（最近24小时）..."

          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.API_URL }}/api/admin-api/sync" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.ADMIN_API_KEY }}" \
            -d '{"type":"incremental"}')

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "========================================"
          echo "测试结果"
          echo "========================================"
          echo "HTTP状态码: $http_code"
          echo "========================================"
          echo "响应内容:"
          echo "$body"
          echo "========================================"

          echo "response=$body" >> $GITHUB_OUTPUT
          echo "status_code=$http_code" >> $GITHUB_OUTPUT

      - name: 检查执行结果
        if: steps.sync.outputs.status_code != '200'
        run: |
          echo "========================================"
          echo "❌ 测试失败"
          echo "========================================"
          echo "状态码: ${{ steps.sync.outputs.status_code }}"
          echo "响应: ${{ steps.sync.outputs.response }}"
          echo "========================================"
          echo "请检查："
          echo "1. API_URL 是否正确配置"
          echo "2. ADMIN_API_KEY 是否正确配置"
          echo "3. EdgeOne 服务是否正常运行"
          echo "========================================"
          exit 1

      - name: 显示执行结果
        if: steps.sync.outputs.status_code == '200'
        run: |
          echo "========================================"
          echo "✅ 测试成功"
          echo "========================================"
          echo "增量同步已启动"
          echo "响应: ${{ steps.sync.outputs.response }}"
          echo "========================================"
          echo "下一步："
          echo "1. 在 Supabase 数据库中检查 videos 表"
          echo "2. 查看是否有新的视频数据"
          echo "3. 检查 updated_at 字段是否更新"
          echo "========================================"