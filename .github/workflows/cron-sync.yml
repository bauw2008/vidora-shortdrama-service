name: 定时同步任务

on:
  # 每分钟检查一次是否有需要执行的定时任务
  schedule:
    - cron: '* * * * *'

  # 允许手动触发（用于测试）
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: 生成带签名的请求
        id: sign
        run: |
          # 获取当前时间戳
          timestamp=$(date +%s)

          # 生成签名 (HMAC-SHA256)
          # 格式: ${timestamp}-${SIGNING_SECRET}
          # 其中 SIGNING_SECRET 是后端固定的签名密钥
          message="${timestamp}-cron-trigger-signing-key"
          signature=$(echo -n "$message" | openssl dgst -sha256 -hmac "${{ secrets.CRON_SECRET }}" | awk '{print $2}')

          # 组合成完整的 secret
          cron_secret="${timestamp}:${signature}"

          echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
          echo "signature=$signature" >> $GITHUB_OUTPUT
          echo "cron_secret=$cron_secret" >> $GITHUB_OUTPUT

          echo "生成的签名: $signature"
          echo "完整 secret: $cron_secret"

      - name: 调用定时触发器
        id: trigger
        run: |
          echo "调用定时触发器..."

          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.API_URL }}/api/admin/cron-trigger" \
            -H "Content-Type: application/json" \
            -H "x-cron-secret: ${{ steps.sign.outputs.cron_secret }}" \
            -H "User-Agent: GitHub-Actions")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP状态码: $http_code"
          echo "响应内容: $body"

          echo "response=$body" >> $GITHUB_OUTPUT
          echo "status_code=$http_code" >> $GITHUB_OUTPUT

      - name: 检查执行结果
        if: steps.trigger.outputs.status_code != '200'
        run: |
          echo "❌ 定时任务调用失败"
          echo "状态码: ${{ steps.trigger.outputs.status_code }}"
          echo "响应: ${{ steps.trigger.outputs.response }}"
          exit 1

      - name: 显示执行结果
        if: steps.trigger.outputs.status_code == '200'
        run: |
          echo "✅ 定时任务调用成功"
          echo "响应: ${{ steps.trigger.outputs.response }}"
